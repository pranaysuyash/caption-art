// Caption Art - Prisma ORM Schema
// Defines the database schema for Caption Art platform

datasource db {
  // Provider and url are now configurable via environment variables.
  // This allows running SQLite locally (provider=sqlite) and Postgres in
  // production (provider=postgresql) without editing the schema file.
  // NOTE: env() is not supported for provider, defaulting to sqlite for now.
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Agency - Billing and license management
model Agency {
  id              String   @id @default(cuid())
  name            String   @default("My Agency")
  licenseKey      String?
  billingActive   Boolean  @default(true)
  planType        String   @default("free") // free | paid
  timezone        String   @default("UTC")
  language        String   @default("en")
  contactEmail    String?
  contactPhone    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  // Relations
  users           User[]
  workspaces      Workspace[]
  brandKits       BrandKit[]
  roles           Role[]
  auditLogs       AuditLog[]
  subscription    Subscription?
  integrations    Integration[]
  featureFlags    FeatureFlag[]

  @@map("agencies")
}

// User - Individual user accounts
model User {
  id              String   @id @default(cuid())
  email           String   @unique
  password        String? // Hashed password (null for OAuth)
  name            String?
  avatar          String?
  agencyId        String
  status          String   @default("active") // active | suspended | invited
  lastLoginAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  // Relations
  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  auditLogs       AuditLog[]

  @@index([agencyId])
  @@index([status])
  @@map("users")
}

// Workspace - Client project workspace
model Workspace {
  id              String   @id @default(cuid())
  agencyId        String
  clientName      String
  industry        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  brandKit        BrandKit?
  campaigns       Campaign[]
  assets          Asset[]
  captions        Caption[]
  approvals       Approval[]
  generatedAssets GeneratedAsset[]
  batchJobs       BatchJob[]
  userRoles       UserRole[]

  @@index([agencyId])
  @@map("workspaces")
}

// Brand Kit - Brand guidelines and voice
model BrandKit {
  id                  String   @id @default(cuid())
  workspaceId         String   @unique
  agencyId            String
  name                String?
  
  // Colors
  primaryColor        String?
  secondaryColor      String?
  tertiaryColor       String?
  
  // Fonts
  headingFont         String?
  bodyFont            String?
  
  // Logo
  logoUrl             String?
  logoPosition        String? // top-left | top-right | bottom-left | bottom-right
  
  // Voice & Tone
  voicePrompt         String?
  brandPersonality    String?
  targetAudience      String?
  valueProposition    String?
  toneStyle           String? // professional | playful | bold | minimal | luxury | edgy
  toneOfVoice         String?
  
  // Content Guidelines
  forbiddenPhrases    String?   // Stored as JSON string
  preferredPhrases    String?   // Stored as JSON string
  keywords            String?   // Stored as JSON string
  values              String?   // Stored as JSON string
  keyDifferentiators  String?   // Stored as JSON string
  imageryStyle        String?
  
  // Masking Model Selection
  maskingModel        String? // rembg-replicate | sam3 | rf-detr | roboflow | hf-model-id
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  agency              Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  campaigns           Campaign[]

  @@index([workspaceId])
  @@index([agencyId])
  @@map("brand_kits")
}

// Campaign - Marketing campaign
model Campaign {
  id                String   @id @default(cuid())
  workspaceId       String
  brandKitId        String?  
  name              String
  description       String?
  status            String   @default("draft") // draft | active | paused | completed | archived
  primaryOffer      String?
  targetAudience    String?
  callToAction      String?
  secondaryCTA      String?
  keywords          String?   // Stored as JSON string
  placements        String?   // Stored as JSON string
  mustIncludePhrases String?  // Stored as JSON string
  mustExcludePhrases String?  // Stored as JSON string
  headlineMaxLength Int?
  bodyMaxLength     Int?
  referenceCaptions String?   // Stored as JSON string
  
  // Campaign brief data
  briefData         Json?   // Stores campaign brief as JSON
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  brandKit          BrandKit? @relation(fields: [brandKitId], references: [id], onDelete: SetNull)
  assets            Asset[]
  captions          Caption[]
  creatives         AdCreative[]
  approvals         Approval[]
  generatedAssets   GeneratedAsset[]

  @@index([workspaceId])
  @@index([brandKitId])
  @@map("campaigns")
}

// Asset - Image or media file
model Asset {
  id                String   @id @default(cuid())
  workspaceId       String
  campaignId        String?
  originalName      String
  mimeType          String   // e.g., image/jpeg
  url               String   // S3 URL
  thumbnailUrl      String?
  size              Int      // File size in bytes
  width             Int?     // Image width
  height            Int?     // Image height
  uploadedAt        DateTime @default(now())

  // Relations
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  campaign          Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  captions          Caption[]
  masks             Mask[]
  generatedAssets   GeneratedAsset[]

  @@index([workspaceId])
  @@index([campaignId])
  @@map("assets")
}

// Caption - Generated caption for an asset
model Caption {
  id                String   @id @default(cuid())
  workspaceId       String
  campaignId        String?
  assetId           String
  status            String   @default("pending") // pending | processing | completed | failed
  approvalStatus    String   @default("pending") // pending | approved | rejected
  
  // Primary caption text
  baseCaption       String?
  primaryText       String?
  
  // Quality metrics
  qualityScore      Float?   // 1-10 quality score
  scoreBreakdown    Json?    // Stores breakdown as JSON
  
  // Captions variations
  variations        CaptionVariation[]
  primaryVariationId String?
  
  // Error handling
  errorMessage      String?
  
  // Timestamps
  generatedAt       DateTime @default(now())
  approvedAt        DateTime?
  rejectedAt        DateTime?
  updatedAt         DateTime @updatedAt

  // Relations
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  campaign          Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  asset             Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  approvals         Approval[]
  generatedAssets   GeneratedAsset[]

  @@index([workspaceId])
  @@index([campaignId])
  @@index([assetId])
  @@index([approvalStatus])
  @@map("captions")
}

// Caption Variation - Alternative caption option
model CaptionVariation {
  id                String   @id @default(cuid())
  captionId         String
  text              String
  tone              String?  // default | witty | inspirational | formal
  format            String?  // social media format (ig-feed, tiktok, linkedin, etc.)
  approvalStatus    String   @default("pending") // pending | approved | rejected
  createdAt         DateTime @default(now())

  // Relations
  caption           Caption  @relation(fields: [captionId], references: [id], onDelete: Cascade)

  @@index([captionId])
  @@map("caption_variations")
}

// Mask - Background mask for text overlay effect
model Mask {
  id                String   @id @default(cuid())
  assetId           String
  url               String   // S3 URL to mask image
  modelUsed         String?  // Which model generated this
  createdAt         DateTime @default(now())

  // Relations
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@map("masks")
}

// Ad Creative - Multi-format advertising creative
model AdCreative {
  id                String   @id @default(cuid())
  campaignId        String
  headline          String
  bodyText          String
  ctaText           String?
  placement         String   // ig-feed | facebook | tiktok | etc
  format            String   // instagram-square | linkedin-post | etc
  imageUrl          String?
  approvalStatus    String   @default("pending")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  campaign          Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  approvals         Approval[]

  @@index([campaignId])
  @@map("ad_creatives")
}

// Approval - Approval workflow records
model Approval {
  id                String   @id @default(cuid())
  workspaceId       String
  campaignId        String?
  captionId         String?
  creativeId        String?
  status            String   @default("pending") // pending | approved | rejected | needs-revision
  feedback          String?
  reviewedBy        String?
  reviewedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  campaign          Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  caption           Caption?  @relation(fields: [captionId], references: [id], onDelete: SetNull)
  creative          AdCreative? @relation(fields: [creativeId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([campaignId])
  @@index([captionId])
  @@index([status])
  @@map("approvals")
}

// Batch Job - Background job for batch operations
model BatchJob {
  id                String   @id @default(cuid())
  workspaceId       String
  jobType           String   // caption | mask | export | render | etc
  status            String   @default("pending") // pending | processing | completed | failed
  progress          Int      @default(0) // 0-100%
  itemsTotal        Int      @default(0)
  itemsProcessed    Int      @default(0)
  itemsFailed       Int      @default(0)
  result            Json?    // Stores result data as JSON
  errorMessage      String?
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  workspace         Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([status])
  @@map("batch_jobs")
}

// Export Job - Track export operations
model ExportJob {
  id                String   @id @default(cuid())
  workspaceId       String
  campaignId        String?
  format            String   // zip | csv | json | etc
  status            String   @default("pending") // pending | processing | completed | failed
  downloadUrl       String?
  expiresAt         DateTime?
  errorMessage      String?
  itemsTotal        Int      @default(0)
  itemsExported     Int      @default(0)
  startedAt         DateTime?
  completedAt       DateTime?
  createdAt         DateTime @default(now())

  @@index([workspaceId])
  @@index([status])
  @@map("export_jobs")
}

// Performance Metrics - Analytics and performance tracking
model PerformanceMetric {
  id                String   @id @default(cuid())
  workspaceId       String?
  entityType        String   // caption | creative | campaign | etc
  entityId          String
  metricType        String   // click_rate | engagement | conversion | etc
  value             Float
  recordedAt        DateTime @default(now())

  @@index([workspaceId])
  @@index([entityType])
  @@index([recordedAt])
  @@map("performance_metrics")
}

// GeneratedAsset - Rendered images/posts ready for approval/export
model GeneratedAsset {
  id             String   @id @default(cuid())
  workspaceId    String
  campaignId     String?
  assetId        String?
  captionId      String?
  jobId          String?
  format         String
  layout         String
  captionText    String?
  imageUrl       String
  thumbnailUrl   String?
  approvalStatus String   @default("pending") // pending | approved | rejected
  watermark      Boolean  @default(false)
  approvedAt     DateTime?
  rejectedAt     DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  campaign  Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  asset     Asset?    @relation(fields: [assetId], references: [id], onDelete: SetNull)
  caption   Caption?  @relation(fields: [captionId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([campaignId])
  @@index([captionId])
  @@index([approvalStatus])
  @@map("generated_assets")
}

// Role - User role definitions
model Role {
  id              String   @id @default(cuid())
  agencyId        String
  name            String   // Owner, Admin, Member, Viewer, Custom
  description     String?
  permissions     Json     // Permission matrix as JSON
  isSystem        Boolean  @default(false) // System roles can't be deleted
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]

  @@unique([agencyId, name])
  @@index([agencyId])
  @@map("roles")
}

// UserRole - User to role assignment (with optional workspace scope)
model UserRole {
  id              String   @id @default(cuid())
  userId          String
  roleId          String
  workspaceId     String?  // Null = agency-wide role
  grantedAt       DateTime @default(now())
  grantedBy       String?  // User ID who granted this role

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  workspace       Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, workspaceId])
  @@index([userId])
  @@index([roleId])
  @@index([workspaceId])
  @@map("user_roles")
}

// AuditLog - Activity and security audit trail
model AuditLog {
  id              String   @id @default(cuid())
  agencyId        String
  userId          String?  // Null for system actions
  action          String   // login, create, update, delete, approve, invite, etc.
  entityType      String   // user, workspace, campaign, brandkit, etc.
  entityId        String?
  details         Json?    // Additional context
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())

  // Relations
  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([agencyId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// Subscription - Billing and plan management
model Subscription {
  id                    String   @id @default(cuid())
  agencyId              String   @unique
  planId                String   // starter, professional, enterprise
  planName              String   // Display name
  status                String   // active, canceled, past_due, trial
  seats                 Int      @default(1)
  seatsUsed             Int      @default(0)
  billingCycle          String   // monthly, annual
  amount                Float    // Price per billing cycle
  currency              String   @default("USD")
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean  @default(false)
  trialEndsAt           DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  agency                Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  invoices              Invoice[]

  @@index([agencyId])
  @@index([status])
  @@map("subscriptions")
}

// Invoice - Billing invoice records
model Invoice {
  id              String   @id @default(cuid())
  subscriptionId  String
  invoiceNumber   String   @unique
  amount          Float
  currency        String   @default("USD")
  status          String   // paid, pending, failed, refunded
  description     String?
  paidAt          DateTime?
  dueDate         DateTime
  invoiceUrl      String?  // PDF download URL
  createdAt       DateTime @default(now())

  // Relations
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
  @@index([invoiceNumber])
  @@map("invoices")
}

// Integration - Third-party integrations and API keys
model Integration {
  id              String   @id @default(cuid())
  agencyId        String
  type            String   // api_key, oauth, sso, webhook
  provider        String   // instagram, facebook, zapier, google, etc.
  name            String   // Display name
  config          Json     // API keys, tokens, endpoints, scopes
  isActive        Boolean  @default(true)
  lastUsedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([provider])
  @@map("integrations")
}

// FeatureFlag - Feature toggles and agency preferences
model FeatureFlag {
  id              String   @id @default(cuid())
  agencyId        String
  featureKey      String   // ai_captions, batch_export, white_label, etc.
  isEnabled       Boolean  @default(true)
  config          Json?    // Feature-specific configuration
  updatedAt       DateTime @updatedAt
  updatedBy       String?  // User ID who last updated

  // Relations
  agency          Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, featureKey])
  @@index([agencyId])
  @@index([featureKey])
  @@map("feature_flags")
}
